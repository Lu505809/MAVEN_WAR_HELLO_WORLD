pipeline{
    agent {
        label 'ansible'
    }
    tools {
      maven 'MVN_HOME'
    }
	
	
    environment {
        DOCKER_HUB_CREDENTIALS = credentials('docker-hub-creds')

        DOCKER_REGISTRY = '' // empty means dockerhub
        DOCKER_IMAGE_NAME = 'luuuyang/tomcat_example'
        DOCKER_IMAGE_TAG = 'latest'
    }

    stages{
       stage('Maven Build') {
         steps {
			// print system information
		   sh "uname -a";
		   
		   // mvn build
		   echo 'start: mvn clean package'
           sh "mvn clean package"
		   
         }
		 
		 post {
		   always {
				echo "end: mvn clean package"
		   }
		   success {
				junit '**/target/surefire-reports/TEST-*.xml'
		   }
		 }
       }
       
      stage('Docker Build'){
            steps{
				// sh "sudo docker build -t luuuyang/tomcat_example .";
                echo 'Starting to build docker image'

                script {
					 docker.build("${DOCKER_IMAGE_NAME}")
                }
            }
			
        }
        
      stage('DockerHub Push'){
            steps{
				// sh "sudo docker login -u ${DOCKER_HUB_CREDENTIALS_USR} -p ${DOCKER_HUB_CREDENTIALS_PSW}"
                // sh "sudo docker push luuuyang/tomcat_example:latest"
				
                script {
                    docker.withRegistry('https://${DOCKER_REGISTRY}', 'docker-hub-creds') {
                        docker.image("${DOCKER_REGISTRY}/${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG}").push()
                    }
				}
            }
        }
  
      stage('Docker Deploy'){
            steps{
				sh "ansible-playbook client.yaml"
            }
        }        
    }
    
}
