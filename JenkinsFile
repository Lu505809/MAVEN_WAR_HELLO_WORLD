pipeline{
    agent {
        label 'ansible'
    }
    tools {
      maven 'MVN_HOME'
    }
	
	
    environment {
        DOCKER_HUB_CREDENTIALS = credentials('docker-hub-creds')
    }

    stages{
       stage('Maven Build') {
         steps {
			// print system information
		   sh "uname -a";
		   
		   // mvn build
		   echo 'start: mvn clean package'
           sh "mvn clean package"
		   
         }
		 
		 post {
		   always {
				echo "end: mvn clean package"
		   }
		   success {
				junit '**/target/surefire-reports/TEST-*.xml'
		   }
		 }
       }
       
      stage('Docker Build'){
            steps{
				sh "sudo docker build -t luuuyang/tomcat_example .";
            }
        }
        
      stage('DockerHub Push'){
            steps{
				sh "sudo docker login -u ${DOCKER_HUB_CREDENTIALS_USR} -p ${DOCKER_HUB_CREDENTIALS_PSW}"
                sh "sudo docker push luuuyang/tomcat_example:latest"
            }
        }
  
      stage('Docker Deploy'){
            steps{
                echo 'You should use the ansiblePlaybook syntax in order to call your playbook'
                echo 'But before that you need to create an agent in order to execute the playbook on the Ansible controle node machine'
            }
        }        
    }
    
}
